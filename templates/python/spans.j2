{% import 'common.j2' as c -%}
from contextlib import AbstractContextManager
from typing import Optional
from opentelemetry.trace import Tracer, Span, SpanKind


{% for span in ctx.spans %}
{%- set func_name = span.type | replace(".", "_") %}
{%- set sampling_attrs = span.attributes | selectattr("sampling_relevant") | list %}
{%- set has_local = [] %}
{%- for attr in sampling_attrs if attr.key | split(".") | first == ctx.root_namespace %}
{%- if loop.first %}
from .attributes import {% endif %}{{ attr.key | screaming_snake_case }}{% if not loop.last %}, {% endif %}
{%- endfor %}

def start_{{ func_name }}(
    tracer: Tracer,
    name: str,
{%- for attr in sampling_attrs %}
{%- set param = attr.key | replace(".", "_") %}
{%- if attr.requirement_level == "required" %}
    {{ param }}: {{ c.py_type(attr) | trim }},
{%- else %}
    {{ param }}: Optional[{{ c.py_type(attr) | trim }}] = None,
{%- endif %}
{%- endfor %}
) -> AbstractContextManager[Span]:
    {%- if c.str_or_empty(span.brief) | length %}
    """{{ span.brief | trim }}"""
    {%- endif %}
    attrs = {
{%- for attr in sampling_attrs %}
{%- set param = attr.key | replace(".", "_") %}
        {{ c.attr_key(attr) | trim }}: {{ param }},
{%- endfor %}
    }
    return tracer.start_as_current_span(
        name,
        kind={{ span.kind | map_text("span_kind_to_py") }},
        attributes={k: v for k, v in attrs.items() if v is not None},
    )
{% endfor %}
